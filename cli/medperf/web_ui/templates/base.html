{# ./cli/medperf/web_ui/templates/base.html #}

{% import 'macros/modal_macros.html' as modal_macros %}

{% set task_running = request.app.state.task.running %}
{% set logged_in = request.app.state.logged_in %}


{% set notifications = request.app.state.notifications %}
{% set unread_notifications = request.app.state.unread_count %}

{% if task_running %}
    {% set task_formData = request.app.state.task.formData %}
{% endif %}

<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}MedPerf{% endblock %}</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"> -->
    <link href="{{ url_for('static', path='css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/font-awesome-5.15.4-all.min.css') }}">
    <!-- https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/prism-1.23.0.min.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', path='css/common.css') }}">
    <link rel="icon" href="{{ url_for('static', path='images/favicon.png') }}">
    {% block extra_css %} {% endblock extra_css %}
    <script>
        window.notifications = {{ notifications | tojson }};
        window.maxLogMessages = Number("{{ request.app.state.MAXLOGMESSAGES }}");
        window.evSource = null;
    </script>
    {% if task_running %}
    {# Save running task id a global variable #}
    <script>
        window.runningTaskId = "{{ request.app.state.task.id }}";
    </script>
    {% endif %}
</head>
<body>
    {% include "partials/navbar.html" %}
    <div class="page-wrap mt-5">
        <div class="main-content">
            {% block content %}{% endblock %}
        </div>
    </div>
    <div class="modal fade" id="page-modal" tabindex="-1">
        <div class="modal-dialog" id="page-modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-5" id="page-modal-title"></h5>
                </div>
                <div class="modal-body" id="page-modal-body"></div>
                <div class="modal-footer" id="page-modal-footer"></div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3"></div>
    {% include "partials/footer.html" %}
    <!-- jQuery and Bootstrap JS -->
    <script src="{{ url_for('static', path='js/jquery-3.6.0.min.js') }}"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script> -->
    <script src="{{ url_for('static', path='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', path='js/bootstrap.bundle.min.js') }}"></script>
    <!-- Prism.js for syntax highlighting -->
    <script src="{{ url_for('static', path='js/prism-1.23.0.min.js') }}"></script>
    <!-- https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-yaml.min.js -->

    <script src="{{ url_for('static', path='js/prism-yaml-1.23.0.min.js') }}"></script>
    <script src="{{ url_for('static', path='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', path='js/common.js') }}"></script>
    {% if task_running %}
    <script data-testid="global-event-source-script">
    if (!window.globalEventSource) {
        window.globalEventSource = new EventSource("/events/global");

        window.globalEventSource.addEventListener("notification", function(e) {
            const data = JSON.parse(e.data);
            processNotification(data);
        });

        window.globalEventSource.addEventListener("event", function(e) {
            const data = JSON.parse(e.data);
            showCriticalPopup(data);
        });
    }
    $(window).on("beforeunload pagehide", () => {
        if(window.globalEventSource){
            window.globalEventSource.close();
            window.globalEventSource = null;
        }
    });
    </script>
    {% else %}
    <script data-testid="global-events-script">
        const data = `{{ request.app.state.global_events | tojson | safe }}`;
        const events = JSON.parse(data);
        events.forEach(event => {
           showCriticalPopup(event); 
        });
    </script>
    {% endif %}
    {% block extra_js %} {% endblock extra_js %}
</body>
</html>
