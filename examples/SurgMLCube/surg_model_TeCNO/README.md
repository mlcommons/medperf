# Model MLCube for TeCNO Model

This MLCube is for running inference on surgical videos datasets for the task of surgical phase recognition using [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33) model.<br><br>


## Input Data Structure

The following (default) directory tree is expected:

```
surg_model_TeCNO
├── mlcube
│   ├── workspace
│   │   ├── data
│   │   │   ├── frames
│   │   │   └── data_csv
│   │   │
│   │   ├── additional_files
│   │   │   ├── feature_extraction_weights
│   │   │   └── mstcn_weights
│   │   │
│   │   └── parameters.yaml
│   │   
│   └── mlcube.yaml
└── project

```

The locations and names of each of ```data```, ```feature_extraction_weights```, ```mstcn_weights```, and ```parameters.yaml``` can be different but should be specified either in [mlcube.yaml](mlcube/mlcube.yaml) or the command line arguments when running the MLCube using the ```mlcube``` tool.

The folder ```data``` should have the same structure as the same named folder generated by the [data preparation MLCube](../surg_prep/README.md).

The folder ```additional_files``` contains model weights for the feature extractor of [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33) (ResNet50) and contains model weights for the multi-stage temporal convolutional network of [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33).

<br><br>

## Supported Data formats

Currently, model weights should have the [TensorFlow saved checkpoint](https://www.tensorflow.org/tutorials/keras/save_and_load#what_are_these_files) format. Note that the feature extractor weights are expected to not include the last Dense Layer that was used during training.

<br><br>


## Configuration

The following parameters can be adjusted in the [parameters.yaml](mlcube/workspace/parameters.yaml) file for configuring the inference:

  * ```batch_size```: The batchsize to be used during inference.
  * ```num_stages```: The number of stages of the temporal convolutional network. More information can be found in [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33) paper.
  * ```num_layers```: The number of network layers per stage. More information can be found in [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33) paper.
  * ```num_f_maps```: The number of intermediate feature maps used. More information can be found in [TeCNO](https://doi.org/10.1007/978-3-030-59716-0_33) paper.
  * ```num_classes```: The number of classes in the dataset.

The MLCube is by default configured to run on the GPU if a GPU is detected, otherwise, it is run on the CPU. When intending to use a GPU, a minimum NVIDIA driver version of 418.39 must be met. If GPUs must not be used, ```accelerator_count``` in the [mlcube.yaml](mlcube/mlcube.yaml) file can be set to `0`.

<br><br>

## MLCube built-in Tasks

The final (default) directory tree will be as follows:
<pre>
surg_model_TeCNO
├── mlcube
│   ├── workspace
│   │   ├── data
│   │   │   ├── frames
│   │   │   └── data_csv
│   │   │
│   │   ├── additional_files
│   │   │   ├── feature_extraction_weights
│   │   │   └── mstcn_weights
│   │   │
│   │   ├── parameters.yaml
│   │   │
│   │   <b>└── predictions</b>
│   │       <b>├── some_video.csv</b>
│   │       <b>├── other_video.csv</b>
│   │       <b>└ ...</b>
│   │   
│   └── mlcube.yaml
└── project
</pre>

The location and name of ```predictions``` can be different but should be specified either in [mlcube.yaml](mlcube/mlcube.yaml) or the command line arguments when running the MLCube using the ```mlcube``` tool.

<br><br>

### Task ```infer```

The model is run against the prepared data found in ```data``` folder, and:
  * An output folder is created (```predictions```)
  * For each video, a csv file is created that links each frame path with the ground truth label and the predicted label. Written paths of the frames are relative to the ```data``` folder.
