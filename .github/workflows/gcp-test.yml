name: Integration workflow(GCP)

on: pull_request  

jobs:
  setup:
    name: gcp-deploy
    runs-on: ubuntu-latest
    env:
      REGION: us-west1
      ARTIFACT_REGISTRY_DOMAIN: docker.pkg.dev
      REPO_NAME: medperf-repo
      IMAGE_NAME: medperf-api-ci
      SERVICE_NAME: medperf-api-ci-service
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - id: auth
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Set up cloud sdk
      uses: google-github-actions/setup-gcloud@v0
    
    - name: Configure docker
      run: gcloud auth configure-docker ${{ env.REGION }}-${{ env.ARTIFACT_REGISTRY_DOMAIN }} --quiet

    - name: Set server environment vars
      working-directory: ./server
      run: cp .env.example .env

    - name: Build container image
      working-directory: ./server
      run: docker build -t ${{ env.REGION }}-${{ env.ARTIFACT_REGISTRY_DOMAIN }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }} -f Dockerfile .

    - name: Push container image
      run: docker push ${{ env.REGION }}-${{ env.ARTIFACT_REGISTRY_DOMAIN }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}
    
    - name: Deploy service to cloud run
      run: gcloud run deploy ${{ env.SERVICE_NAME }} --image ${{ env.REGION }}-${{ env.ARTIFACT_REGISTRY_DOMAIN }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }} --region ${{ env.REGION }} --platform managed --allow-unauthenticated

    - name: Get service url
      run: echo "DEPLOY_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')"  >> $GITHUB_ENV

    - name: Run integration tests
      working-directory: ./server
      run: sh server.sh -s ${{ env.DEPLOY_URL }}

    - name: Delete service
      run: gcloud run services delete ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --quiet
