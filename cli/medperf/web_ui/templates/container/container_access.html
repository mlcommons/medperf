{# ./cli/medperf/web_ui/templates/container/container_access.html #}

{% extends "detail_base.html" %}

{% block title %}Manage Container Access{% endblock %}


{% block detail_panel %}

{% set auto_access_running = request.app.state.model_auto_give_access["running"] %}
{% if auto_access_running %}
    {% set selected_benchmark = request.app.state.model_auto_give_access["benchmark"] %}
    {% set selected_interval = request.app.state.model_auto_give_access["interval"] %}
    {% set selected_emails = request.app.state.model_auto_give_access["emails"] %}
{% endif %}

<div class="container my-4">
    <a href="/containers/ui/display/{{ entity.id }}" class="text-muted">
        ‚Üê Back to Container Details
    </a>

    <h1 class="mt-3">Manage Access | {{ entity_name }}</h1>
    <p class="text-muted">Control who can access this container.</p>
</div>

<div class="card mt-4 shadow-sm">
    <div class="card-body">
        <h3>Grant Access</h3>
        <p class="text-muted mb-4">
            Add users who can decrypt and run this container.
        </p>

        <div class="form-group mb-4">
            <label class="form-label h6" for="benchmark">Benchmark</label>
            <select name="benchmark" id="benchmark" class="form-select" {% if task_running %} disabled {% endif %}>
                <option value="" disabled selected>Select a benchmark</option>
                {% if benchmarks %}
                {% for benchmark in benchmarks %}
                <option
                    value="{{ benchmark }}"
                >{{ benchmarks[benchmark] }}</option>
                {% endfor %}
                {% else %}
                <option
                    value="" disabled
                >No approved benchmarks to be selected</option>
                {% endif %}
            </select>
        </div>

        <div class="form-group mb-4" id="email-chip-container">
            <label class="form-label h6" for="email-input">
                Allow list emails
            </label>
            <div class="email-container" id="allowed-email-list" data-allowed-list='{}'>
                <input
                    type="text"
                    name="emails"
                    id="email-input"
                    class="form-control email-input mt-2"
                    placeholder="Type email and hit Enter, comma, or space"
                    {% if task_running %} disabled {% endif %}
                >
            </div>
        </div>
        <div class="text-center">
            <button id="grant-access-btn" class="btn btn-primary step-btn" data-model-id="{{ entity.id }}" {% if task_running %} disabled {% endif %}>Grant Access</button>
        </div>
    </div>
</div>

<div class="card mt-5 shadow-sm">
    <div class="card-body">
        <h3>Automatic Access</h3>
        <p class="text-muted">
            Automatically grant access to new data owners associated to a benchmark.
        </p>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label h6">Benchmark</label>
                <select class="form-select" id="benchmark-auto" {% if auto_access_running %}disabled{% endif %}>
                    <option value="" disabled selected>Select a benchmark</option>
                    {% if benchmarks %}
                    {% for benchmark in benchmarks %}
                    <option
                        {% if auto_access_running and selected_benchmark == benchmark %}selected{% endif %}
                        value="{{ benchmark }}"
                    >{{ benchmarks[benchmark] }}</option>
                    {% endfor %}
                    {% else %}
                    <option
                        value="" disabled
                    >No approved benchmarks to be selected</option>
                    {% endif %}
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label h6">Interval (minutes)</label>
                <input
                    type="number"
                    class="form-control"
                    id="interval-auto"
                    min="5"
                    max="60"
                    value="{% if auto_access_running %}{{ selected_interval }}{% else %}5{% endif %}"
                    {% if auto_access_running %}disabled{% endif %}
                    >
            </div>
        </div>
        <div class="form-group mb-4" id="email-chip-container">
            <label class="form-label h6" for="email-input">
                Allow list emails
            </label>
            <div class="email-container" id="allowed-email-list-auto" data-allowed-list='{% if auto_access_running %}{{ selected_emails }}{% else %}{}{% endif %}'>
                <input
                    type="text"
                    name="emails"
                    id="email-input"
                    class="form-control email-input mt-2"
                    placeholder="Type email and hit Enter, comma, or space"
                    {% if task_running %} disabled {% endif %}
                >
            </div>
        </div>
        <div class="text-center mt-3">
            <button
                class="btn btn-info step-btn {% if auto_access_running %}hidden-element{% endif %}"
                id="start-auto-access-btn"
                data-model-id="{{ entity.id }}"
                >Start Automatic Access
            </button>
            <button
                class="btn btn-danger step-btn {% if not auto_access_running %}hidden-element{% endif %}"
                id="stop-auto-access-btn"
                data-model-id="{{ entity.id }}"
                >Stop Automatic Access
            </button>
            <span id="running-badge" class="badge bg-success ms-3 {% if not auto_access_running %}hidden-element{% endif %}">Running</span>
        </div>
    </div>
</div>

<div class="card mt-5 shadow-sm">
    <div class="card-body">
        <h3>Current Access</h3>
        <p class="text-muted">Users who currently have access to this container.</p>

        {% if keys %}
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Key ID</th>
                        <th>User ID</th>
                        <th>Email</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key_id in keys %}
                    <tr>
                        <td>{{ key_id }}</td>
                        <td>{{ keys[key_id].id }}</td>
                        <td>{{ keys[key_id].email }}</td>
                        <td class="text-center">
                            <button
                                id="revoke-btn-{{ key_id }}"
                                class="btn btn-outline-danger btn-sm revoke-access-btn"
                                data-key-id="{{ key_id }}" data-model-id="{{ entity.id }}">
                                Revoke Access
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No users currently have access.</p>
        {% endif %}
    </div>
</div>

<div class="card my-5 border-danger shadow-sm">
    <div class="card-body">
        <h4 class="text-danger">Delete Keys</h4>
        <p class="text-muted">
            This will delete all encrypted access keys for this container.
            Users will lose all ability to run or decrypt it until new keys are generated.
        </p>

        <button class="btn btn-danger step-btn" id="delete-keys-btn" data-model-id="{{ entity.id }}">
            Delete All Keys
        </button>
    </div>
</div>


{% include "partials/panel_container.html" %}
{% include "partials/text_content_container.html" %}
{% include "partials/yaml_container.html" %}
{% include "partials/prompt_container.html" %}


{% endblock detail_panel %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/event_handler.js') }}"></script>
<script src="{{ url_for('static', path='js/containers/container_access.js') }}"></script>
{% if task_running  %}
{% if request.app.state.task.name == "container_grant_access" and task_formData.get("model_id", "") == entity.id|string %}
<script>
    $(document).ready(() => {
        resumeRunningTask(
            "#grant-access-btn",
            `Granting Access...`,
            onGrantAccessSuccess
        );
    });
</script>
{% elif request.app.state.task.name == "container_revoke_key" and task_formData.get("model_id", "") == entity.id|string %}
<script>
    $(document).ready(() => {
        const key_id = "{{ task_formData.get('key_id', '') }}";
        resumeRunningTask(
            `#revoke-btn-${key_id}`,
            null,
            onRevokeUserAccessSuccess
        );
    });
</script>
{% elif request.app.state.task.name == "container_delete_keys" and task_formData.get("model_id", "") == entity.id|string %}
<script>
    $(document).ready(() => {
        resumeRunningTask(
            "#delete-keys-btn",
            null,
            onDeleteKeysSuccess
        );
    });
</script>
{% endif %}
{% endif %}
{% endblock %}