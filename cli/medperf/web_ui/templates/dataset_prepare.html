<!-- ./cli/medperf/web-ui/templates/prepare.html -->
{% extends "base.html" %}

{% block title %}Dataset Preparation{% endblock %}

{% block content %}
<div class="container">
    <h1>Preparing Dataset...</h1>
    <!-- Stage Tracker -->
    <div class="stages">
        <ul class="list-group mb-3" id="stages-list"></ul>
    </div>

    <!-- Real-time log panel -->
    <div class="card">
        <div class="card-body">
            <pre id="log-panel" style="height: 300px; overflow-y: scroll; background-color: #f8f9fa; padding: 15px;"></pre>
        </div>
    </div>

    <!-- Report Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="min-width: 50%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvalModalLabel">Send Report Approval</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="approvalMessage">
                    <!-- This message will be dynamically loaded -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="decline-btn">Decline</button>
                    <button type="button" class="btn btn-primary" id="approve-btn">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success button (hidden initially) -->
    <button class="btn btn-success mt-4" id="complete-btn" style="display:none;">Successfully prepared, go back</button>
</div>

<script>
    // Fetch and stream logs to the log panel
    function startPreparation() {
        const logPanel = document.getElementById('log-panel');
        const stagesList = document.getElementById('stages-list');
        const completeBtn = document.getElementById('complete-btn');

        let currentStageElement = null;

        // Start the initial preparation step
        fetch(`/datasets/prepare_draft/generate?dataset_id={{ dataset_id }}`)
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            // Preparation finished, move to step 2
                            checkForReportApproval();
                            return;
                        }

                        const messages = decoder.decode(value).split("\n");
                        messages.forEach(msg => {
                            if (!msg.trim()) return;

                            try {
                                const log = JSON.parse(msg);
                                handleLogMessage(log);
                            } catch (e) {
                                // Handle non-JSON messages, like plain logs
                                appendToLogPanel(msg, 'print');
                            }
                        });

                        readStream();
                    });
                }

                readStream();
            })
            .catch(error => console.error('Error fetching logs:', error));

        // Handle log messages and update the UI accordingly
        function handleLogMessage(log) {
            // Clean the message from ANSI escape sequences
            const cleanMessage = log.message.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');

            if (log.type === 'text') {
                // New stage
                if (currentStageElement) {
                    markStageAsComplete(currentStageElement);
                }
                addNewStage(cleanMessage);
            } else if (log.type === 'print') {
                // Append to log panel
                appendToLogPanel(cleanMessage, log.type);
            }
        }

        function addNewStage(stageText) {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex align-items-center';
            listItem.innerHTML = `
                <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                <strong>${stageText}</strong>
            `;
            stagesList.appendChild(listItem);
            currentStageElement = listItem;
        }

        function markStageAsComplete(stageElement) {
            const spinner = stageElement.querySelector('.spinner-border');
            if (spinner) {
                spinner.classList.remove('spinner-border', 'spinner-border-sm');
                spinner.classList.add('text-success', 'fas', 'fa-check-circle');
            }
        }

        function appendToLogPanel(message, type) {
            if (type === 'text') {
                logPanel.innerHTML += `<strong>${message}</strong>\n`;
            } else {
                logPanel.innerHTML += `${message}\n`;
            }
            logPanel.scrollTop = logPanel.scrollHeight;  // Scroll to bottom
        }

        // Check if report approval is needed
        function checkForReportApproval() {
            fetch(`/datasets/prepare_draft/ask_send_approval?dataset_id={{ dataset_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ask_for_approval) {
                        // Show the modal and set the message
                        document.getElementById('approvalMessage').innerText = data.message_to_user;
                        $('#approvalModal').modal('show');
                    } else {
                        // If no approval needed, run the preparation directly
                        runPreparation(false);
                    }
                })
                .catch(error => console.error('Error fetching approval request:', error));
        }

        // Function to run the actual preparation after report approval is handled
        function runPreparation(approved) {
            fetch(`/datasets/prepare_draft/run?dataset_id={{ dataset_id }}&approved_sending_reports=${approved}`)
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");

                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // Mark the last stage as complete and show the success button
                                if (currentStageElement) {
                                    markStageAsComplete(currentStageElement);
                                }
                                completeBtn.style.display = 'block';
                                return;
                            }

                            const messages = decoder.decode(value).split("\n");
                            messages.forEach(msg => {
                                if (!msg.trim()) return;

                                try {
                                    const log = JSON.parse(msg);
                                    handleLogMessage(log);
                                } catch (e) {
                                    // Handle non-JSON messages, like plain logs
                                    appendToLogPanel(msg, 'print');
                                }
                            });

                            readStream();
                        });
                    }

                    readStream();
                })
                .catch(error => console.error('Error fetching preparation logs:', error));
        }

        // Handle approval or decline button click
        document.getElementById('approve-btn').addEventListener('click', function() {
            $('#approvalModal').modal('hide');
            runPreparation(true);  // Approved
        });

        document.getElementById('decline-btn').addEventListener('click', function() {
            $('#approvalModal').modal('hide');
            runPreparation(false);  // Declined
        });

        // Redirect to dataset detailed page after preparation
        document.getElementById('complete-btn').addEventListener('click', function() {
            window.location.href = `/datasets/ui/display/{{ dataset_id }}`;
        });
    }

    // Start the process when the page loads
    window.onload = startPreparation;
</script>
{% endblock %}
