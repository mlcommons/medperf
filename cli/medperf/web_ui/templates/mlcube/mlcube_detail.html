<!-- ./cli/medperf/web-ui/templates/mlcube/mlcube_detail.html -->
{% extends "detail_base.html" %}
{% import 'macros/association_card_macros.html' as association_card_macros %}
{% import 'macros/benchmark_macros.html' as benchmark_macros %}

{% block title %}MLCube Details{% endblock %}

{% block detail_panel %}
<h1 class="my-4">{{ entity.name }}</h1>
<div class="{% if entity.is_valid %}card{% else %}invalid-card{% endif %}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Details</h5>
            <span class="badge {% if entity.state == 'OPERATION' %}badge-state-operational{% else %}badge-state-development{% endif %}">
                {{ entity.state }}
            </span>
            <span class="badge {% if entity.is_valid %}badge-valid{% else %}badge-invalid{% endif %}">
                {% if entity.is_valid %}Valid{% else %}Invalid{% endif %}
            </span>
        </div>
        <div class="card mb-3">
            <div class="card-body">
                <p class="card-text">
                    <strong>MLCube:</strong> 
                    <a
                        href="{{ entity.git_mlcube_url }}"
                        data-id="{{ entity.id }}"
                        data-field="git_mlcube_url"
                        data-entity="mlcube"
                        class="text-primary yaml-link">{{ entity.git_mlcube_url }}
                    </a>
                </p>
                <p class="card-text text-muted small">{{ entity.mlcube_hash }}</p>
                <p class="card-text">
                    <strong>Parameters:</strong> 
                    <a
                        href="{{ entity.git_parameters_url }}"
                        data-id="{{ entity.id }}"
                        data-field="git_parameters_url"
                        data-entity="mlcube"
                        class="text-primary yaml-link">
                        {{ entity.git_parameters_url }}
                    </a>
                </p>
                <p class="card-text text-muted small">{{ entity.parameters_hash }}</p>
                {% if entity.image_tarball_url %}
                    <p class="card-text">
                        <strong>Image Tarball:</strong> 
                        <a
                            href="{{ entity.image_tarball_url }}"
                            class="text-primary"
                            target="_blank">{{ entity.image_tarball_url }}
                        </a>
                    </p>
                    <p class="card-text text-muted small">{{ entity.image_tarball_hash }}</p>
                {% else %}
                    <p class="card-text">
                        <strong>Image Tarball:</strong> 
                        Not Available</p>
                    <p class="card-text text-muted small">N/A</p>
                {% endif %}
                {% if entity.additional_files_tarball_url %}
                    <p class="card-text">
                        <strong>Additional Files:</strong> 
                        <a
                            href="{{ entity.additional_files_tarball_url }}"
                            class="text-primary"
                            target="_blank">{{ entity.additional_files_tarball_url }}
                        </a>
                    </p>
                    <p class="card-text text-muted small">{{ entity.additional_files_tarball_hash }}</p>
                {% else %}
                    <p class="card-text">
                        <strong>Additional Files:</strong> 
                        Not Available</p>
                    <p class="card-text text-muted small">N/A</p>
                {% endif %}
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between flex-wrap">
                <div class="w-50">
                    <p class="card-text">
                        <strong>Image Hash:</strong> 
                        <span class="text-muted small">{{ entity.image_hash }}</span>
                    </p>
                    <p class="card-text">
                        <i class="fas fa-user"></i> 
                        <span class="text-muted small">{{ entity.owner }}</span>
                    </p>
                </div>
                <div class="text-right w-50">
                    <p class="card-text">
                        <strong>Created:</strong> 
                        <span class="text-muted small" data-date="{{ entity.created_at }}"></span>
                    </p>
                    <p class="card-text">
                        <strong>Modified:</strong> 
                        <span class="text-muted small" data-date="{{ entity.modified_at }}"></span>
                    </p>
                </div>
            </div>
        </div>
        <div
            class="p-2 card flex-row mt-5 shadow-sm rounded bg-white py-4"
            style="border:1px solid rgba(0, 0, 0, .125);border-radius:.25rem;"
        >
            <div class="col-12 text-center">
                {% if entity.state=="OPERATION" %}
                    <div class="dropdown">
                        <button
                            class="step-btn btn btn-info dropdown-toggle"
                            type="button"
                            id="associate-dropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                        >
                            Associate with Benchmark
                        </button>
                        <div class="dropdown-menu" aria-labelledby="associate-dropdown" id="dropdown-div">
                            {% for benchmark in benchmarks.values() %}
                                {% if benchmark.id not in benchmarks_associations or (benchmark.id in benchmarks_associations and benchmarks_associations[benchmark.id].approval_status == "REJECTED" ) %}
                                    <div
                                        class="dropdown-item benchmark-item"
                                        data-benchmark-id="{{ benchmark.id }}"
                                    >
                                    {{ benchmark_macros.benchmark_card(benchmark) }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <button class="step-btn btn btn-info" disabled>Associate with Benchmark</button>
                    <br>
                {% endif %}
                <small class="step-label ms-2">Make a request to the benchmark owner to associate your model with the benchmark</small>
            </div>
        </div>
    </div>
</div>
<div class="associations-panel">
    <div class="associations-column">
        <h2 class="my-4">Associated Benchmarks</h2>
        {% for assoc in benchmarks_associations.values() %}
            {{ association_card_macros.association_card(assoc, benchmarks[assoc.benchmark], "benchmarks") }}
        {% endfor %}
    </div>
</div>

<div id="panel" class="my-5" style="display: none;">
    <h2 id="panel-title"></h2>

    <div class="stages">
        <ul class="list-group mb-3" id="stages-list"></ul>
    </div>

    <div class="card mt-5">
        <div class="card-body">
            <pre id="log-panel" style="height: 300px; overflow-y: scroll; background-color: #f8f9fa; padding: 15px;"></pre>
        </div>
    </div>
</div>

<div id="text-content" style="display: none;">
    <div id="content"></div>
</div>

<div id="yaml-div" style="display: none;">
    <pre id="yaml-content" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px;"></pre>
</div>

<div id="prompt-div" class="my-5" style="display: none;">
    <div id="prompt-text"></div>
    <div class="text-center mt-5">
        <button type="button" class="btn btn-danger mx-3" id="respond-no">No</button>
        <button type="button" class="btn btn-success mx-3" id="respond-yes">Yes</button>
    </div>
</div>

<div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptTitle"></h5>
            </div>
            <div class="modal-body">
                <p id="promptText"></p>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/event_handler.js"></script>
<script src="/static/js/app.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle the "Associate" dropdown item click
        document.querySelectorAll('.benchmark-item').forEach(item => {
            item.addEventListener('click', function() {
                if (!this.classList.contains('disabled')) {
                    const modelId = "{{ entity.id }}";
					const modelName = "{{ entity.name }}"
                    const benchmarkId = this.getAttribute('data-benchmark-id');
                    associateMLCube(modelId, benchmarkId, modelName, this);
                }
            });
        });
        $("#respond-yes").on("click", respond_yes);
        $("#respond-no").on("click", respond_no);
    });
</script>
{% endblock %}
