function showNextModal(results){
    const modalTitle = "Model Compatibility Test Successful";
    const modalBody = `
    <h5>Results generated by the compatibility test</h5>
    <div class="mt-3"><pre id="result-content" class="language-yaml">${results}</pre></div>
    `;
    const modalFooter = `
    <button type="button" class="btn btn-danger" onclick="reloadPage();">Cancel</button>
    <button type="button" class="btn btn-success" onclick="showRegisterContainer();" data-bs-dismiss="modal">
        Continue to container registration
    </button>`;
    const extra_fn = () => { Prism.highlightElement($("#result-content")[0]); };

    showModal({
        title: modalTitle,
        body: modalBody,
        footer: modalFooter,
        modalClasses: "modal-lg",
        extra_func: extra_fn
    });
}

function onContainerCompatibilityTestSuccess(response){
    markAllStagesAsComplete();
    if(response.status === "success"){
        const results = JSON.stringify(response.results, null, 2);
        showNextModal(results);
    }
    else{
        showErrorModal("Model Compatibility Test Failed", response);
    }
}

async function runContainerCompatibilityTest(runCompTestButton){
    addSpinner(runCompTestButton);

    const formData = new FormData($("#container-comp-test-form")[0]);

    disableElements("#container-comp-test-form input, #container-comp-test-form select, #container-comp-test-form button");

    ajaxRequest(
        "/containers/run_compatibility_test",
        "POST",
        formData,
        onContainerCompatibilityTestSuccess,
        "Error running container compatibility test:"
    )

    showPanel(`Running Compatibility Test...`);
    window.runningTaskId = await getTaskId();
    streamEvents(logPanel, stagesList, currentStageElement);
}

function checkCompTestFormValidity() {
    const containerPath = $("#container-path").val().trim();
    const runTestButton = $("#run-comp-test-btn");
    const isValid = Boolean(
        $("#benchmark").val() &&
        containerPath.length > 0 &&
        containerPath.endsWith(".yaml")
    );

    runTestButton.prop("disabled", !isValid);
}

function showRegisterContainer(){
    window.location.href = "/containers/register/ui";
}

$(document).ready(() => {
    $("#run-comp-test-btn").on("click", (e) => {
        showConfirmModal(e.currentTarget, runContainerCompatibilityTest, "run the compatibility test?");
    });

    $("#container-comp-test-form input, #container-comp-test-form select").on("change keyup", checkCompTestFormValidity);

    $("#browse-container-btn").on("click", () => {
        browseWithFiles = true;
        browseFolderHandler("container-path");
    });
});