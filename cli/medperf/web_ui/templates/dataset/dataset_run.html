{% extends "base.html" %}

{% block title %}Run Results{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Benchmark and Dataset Details Header -->
        <div class="col-12 text-center mb-4">
            <h1 class="mb-3">
                Running Benchmark:
                <a href="/benchmarks/ui/display/{{ benchmark.id }}"><strong>{{ benchmark.name }}</strong></a>
            </h1>
            <p class="lead">
                Evaluating Model
                <a href="/mlcubes/ui/display/{{ model.id }}"><strong>{{ model.name }}</strong></a>
                on Dataset
                <a href="/datasets/ui/display/{{ dataset.id }}"><strong>{{ dataset.name }}</strong></a>
            </p>
        </div>
    </div>

    <div class="row">
        <!-- Dataset Information Card -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    Dataset {{ dataset.name }}
                </div>
                <div class="card-body">
                    <p class="card-text">{{ dataset.description }}</p>
                    <span class="text-muted small" data-date="{{ dataset.created_at }}"></span>
                </div>
            </div>
        </div>
        <!-- Model Information Card -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    Model {{ model.name }}
                </div>
                <div class="card-body">
                    <p class="card-text">{{ model.description }}</p>
                    <span class="text-muted small" data-date="{{ model.created_at }}"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stage Tracker -->
    <div class="stages">
        <ul class="list-group mb-3" id="stages-list"></ul>
    </div>
    <!-- Real-time Log Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    Real-time Logs
                </div>
                <div class="card-body" id="log-panel" style="height: 300px; overflow-y: auto; white-space: pre-wrap;">
                    <!-- Logs will be streamed here -->
                </div>
            </div>
        </div>
    </div>

   <!-- YAML Result Panel (Hidden by Default) -->
    <div class="row mt-4" id="yaml-result-panel" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    Benchmark Results (YAML)
                </div>
                <div class="card-body">
                    <pre id="yaml-results" class="language-yaml"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Button -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <button id="complete-btn" class="btn btn-lg btn-success" disabled>
                <span id="complete-btn-text"><i class="spinner-border spinner-border-sm"></i> Running...</span>
            </button>
        </div>
    </div>
</div>

<script src="/static/js/log_handler.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logPanel = document.getElementById('log-panel');
        const stagesList = document.getElementById('stages-list');
        const yamlPanel = document.getElementById('yaml-result-panel');
        const yamlResults = document.getElementById('yaml-results');
        const completeBtn = document.getElementById('complete-btn');
        const completeBtnText = document.getElementById('complete-btn-text');
        const resultId = "{{ result_id }}";

        let runFinished = false;
        let currentStageElement = null;

        // Fetch and stream logs to the log panel
        async function fetchLogs() {
            try {
                const response = await fetch(`/datasets/run_draft/logs?dataset_id={{ dataset.id }}&benchmark_id={{ benchmark.id }}&model_id={{ model.id }}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                async function readStream() {
                    const { done, value } = await reader.read();
                    if (done) {
                        runFinished = true;
                        checkResult();
                        markStageAsComplete(currentStageElement);
                        return;
                    }

                    const messages = decoder.decode(value).split("\n");
                    messages.forEach(msg => {
                        if (!msg.trim()) return;

                        try {
                            const log = JSON.parse(msg);
                            // Use shared log handler function
                            currentStageElement = handleLogMessage(log, logPanel, stagesList, currentStageElement);
                        } catch (e) {
                            appendToLogPanel(msg, logPanel);
                        }
                    });

                    readStream();
                }

                readStream();
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Check if the run is finished and fetch the result
        async function checkResult() {
            try {
                const response = await fetch(`/datasets/run_draft/status?dataset_id={{ dataset.id }}&benchmark_id={{ benchmark.id }}&model_id={{ model.id }}`);
                const statusData = await response.json();

                completeBtn.disabled = false;
                if (statusData.status === 'executed') {
                    displayYamlResult(statusData.result.results);
                    completeBtnText.innerHTML = '✅ Executed';
                }
                if (statusData.status === 'submitted') {
                    displayYamlResult(statusData.result.results);
                    completeBtnText.innerHTML = '✅ Submitted';
                } else if (statusData.status === 'failed') {
                    completeBtnText.innerHTML = '❌ Failed';
                } else {
                    completeBtnText.innerHTML = '✅ Executed';

                }
            } catch (error) {
                console.error('Error checking result:', error);
            }
        }

        // Display result in YAML format
        function displayYamlResult(result) {
            yamlPanel.style.display = 'block';
            yamlResults.textContent = JSON.stringify(result, null, 2); // Convert JSON to YAML-like formatting
            Prism.highlightElement(yamlResults);
        }

        // Redirect to dataset detail page when the button is clicked
        completeBtn.addEventListener('click', function() {
            window.location.href = `/datasets/ui/display/{{ dataset.id }}`;
        });

        // Start fetching logs when the page loads
        fetchLogs();
    });
</script>
{% endblock %}
