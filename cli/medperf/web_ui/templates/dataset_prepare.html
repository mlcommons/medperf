<!-- ./cli/medperf/web-ui/templates/prepare.html -->
{% extends "base.html" %}

{% block title %}Dataset Preparation{% endblock %}

{% block content %}
<div class="container">
    <h1>Preparing Dataset...</h1>

    <!-- Real-time log panel -->
    <div class="card">
        <div class="card-body">
            <pre id="log-panel" style="height: 300px; overflow-y: scroll; background-color: #f8f9fa; padding: 15px;"></pre>
        </div>
    </div>

    <!-- Report Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="min-width: 50%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvalModalLabel">Send Report Approval</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="approvalMessage">
                    <!-- This message will be dynamically loaded -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="decline-btn">Decline</button>
                    <button type="button" class="btn btn-primary" id="approve-btn">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success button (hidden initially) -->
    <button class="btn btn-success mt-4" id="complete-btn" style="display:none;">Successfully prepared, go back</button>
</div>

<script>
    // Fetch and stream logs to the log panel
    function startPreparation() {
        const logPanel = document.getElementById('log-panel');
        const completeBtn = document.getElementById('complete-btn');

        fetch(`/datasets/prepare_draft/generate?dataset_id={{ dataset_id }}`)
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            // Preparation finished, move to step 2
                            checkForReportApproval();
                            return;
                        }

                        logPanel.innerHTML += decoder.decode(value);
                        logPanel.scrollTop = logPanel.scrollHeight;  // Scroll to bottom
                        readStream();
                    });
                }

                readStream();
            })
            .catch(error => console.error('Error fetching logs:', error));
    }

    // Check if report approval is needed
    function checkForReportApproval() {
        fetch(`/datasets/prepare_draft/ask_send_approval?dataset_id={{ dataset_id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.ask_for_approval) {
                    // Show the modal and set the message
                    document.getElementById('approvalMessage').innerText = data.message_to_user;
                    $('#approvalModal').modal('show');
                } else {
                    // If no approval needed, run the preparation directly
                    runPreparation(false);
                }
            })
            .catch(error => console.error('Error fetching approval request:', error));
    }

    // Function to run preparation and stream logs
    function runPreparation(approved) {
        const logPanel = document.getElementById('log-panel');
        fetch(`/datasets/prepare_draft/run?dataset_id={{ dataset_id }}&approved_sending_reports=${approved}`)
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            // Show complete button when the process is finished
                            document.getElementById('complete-btn').style.display = 'block';
                            return;
                        }

                        logPanel.innerHTML += decoder.decode(value);
                        logPanel.scrollTop = logPanel.scrollHeight;  // Scroll to bottom
                        readStream();
                    });
                }

                readStream();
            })
            .catch(error => console.error('Error fetching preparation logs:', error));
    }

    // Handle approval or decline button click
    document.getElementById('approve-btn').addEventListener('click', function() {
        $('#approvalModal').modal('hide');
        runPreparation(true);  // Approved
    });

    document.getElementById('decline-btn').addEventListener('click', function() {
        $('#approvalModal').modal('hide');
        runPreparation(false);  // Declined
    });

    // Redirect to dataset detailed page after preparation
    document.getElementById('complete-btn').addEventListener('click', function() {
        window.location.href = `/datasets/ui/display/{{ dataset_id }}`;
    });

    // Start the process when the page loads
    window.onload = startPreparation;
</script>
{% endblock %}
