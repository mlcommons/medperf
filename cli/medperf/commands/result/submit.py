from medperf.utils import pretty_error, dict_pretty_print, approval_prompt
from medperf.entities.result import Result
from medperf.entities.dataset import Dataset
from medperf.enums import Status


class ResultSubmission:
    @classmethod
    def run(cls, benchmark_uid, data_uid, model_uid, comms, ui, approved=False):
        dset = Dataset(data_uid)
        sub = cls(benchmark_uid, dset.uid, model_uid, comms, ui, approved=approved)
        sub.upload_results()

    def __init__(self, benchmark_uid, data_uid, model_uid, comms, ui, approved=False):
        self.benchmark_uid = benchmark_uid
        self.data_uid = data_uid
        self.model_uid = model_uid
        self.comms = comms
        self.ui = ui
        self.approved = approved

    def request_approval(self, result):
        if result.status == Status.APPROVED:
            return True

        dict_pretty_print(result.todict(), self.ui)
        self.ui.print("Above are the results generated by the model")

        approved = approval_prompt(
            "Do you approve uploading the presented results to the MLCommons comms? [Y/n]",
            self.ui,
        )

        return approved

    def upload_results(self):
        result = Result(self.benchmark_uid, self.data_uid, self.model_uid)
        approved = self.approved or self.request_approval(result)

        if not approved:
            msg = "Results upload operation cancelled"
            pretty_error(msg, self.ui, add_instructions=False)

        result.upload(self.comms)
